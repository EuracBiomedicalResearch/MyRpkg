"0",""
"0","if(!(""distance_for_all_bray"" %in% ls())){"
"0","distance_for_all_bray <- distance(microbiome::transform(chrismb_phy_core_ped_selected_samples, ""compositional""), ""bray"")"
"0","}"
"0",""
"0","n_members <- 2"
"0",""
"0","tallied_house <- chrismb_phy_core_ped_selected_samples %>% "
"0","      meta() %>% "
"0","      group_by(HHID) %>% "
"0","      tally()"
"0",""
"0","HHID_duplets <- filter(tallied_house, n == n_members)"
"0",""
"0","phy_age_strat_useful_HHID_list <- list()"
"0",""
"0","for(smoking_gr in levels(factor(chrismb_phy_core_ped_selected_samples@sam_data$smoking_exposure_ga))){"
"0","  "
"0","    tmp <- chrismb_phy_core_ped_selected_samples %>%"
"0","      meta() %>%"
"0","      filter(smoking_exposure_ga == smoking_gr)"
"0","      "
"0","    HHID_useful <- intersect(tmp$HHID, HHID_duplets$HHID)"
"0","    "
"0","    "
"0","  phy_age_strat_useful_HHID_list[[smoking_gr]] <- tryCatch(expr = {subset_samples(chrismb_phy_core_ped_selected_samples, HHID %in% HHID_useful) %>% subset_samples(smoking_exposure_ga == smoking_gr)}, error = function(e) {return(""empty"")})"
"0","}"
"0",""
"0","## after getting the useful phyloseq objects, summarise by age group"
"0","cat(""N° samples per age category of people living at least with another person in their age range"")"
"1","N° samples per age category of people living at least with another person in their age range"
"0","sample_size_map <- sapply(phy_age_strat_useful_HHID_list, nsamples) %>% data.frame() %>% "
"0","  rownames_to_column(""smoking_exposure_ga"") %>% "
"0","  set_names(c(""smoking_exposure_ga"", ""n_samples"")) %>% "
"0","  mutate(full_name = paste0(smoking_exposure_ga, "" (n="", n_samples, "")""))"
"0",""
"0","# calculate within and between diversities"
"0",""
"0","betadivs_separated_age <- lapply(phy_age_strat_useful_HHID_list, beta_div_betw_withn, dist = distance_for_all_bray, variab= ""HHID"", verbose = TRUE, btwn_pairwise = FALSE)"
"1","[1]"
"1"," ""using dist as distance matrix/distance"""
"1","
"
"1","[1]"
"1"," ""extracting within-group diversities..."""
"1","
"
"1","[1]"
"1"," ""extracting between-group diversities, one-vs-all"""
"1","
"
"1","[1]"
"1"," ""using dist as distance matrix/distance"""
"1","
"
"1","[1]"
"1"," ""extracting within-group diversities..."""
"1","
"
"1","[1]"
"1"," ""extracting between-group diversities, one-vs-all"""
"1","
"
"1","[1]"
"1"," ""using dist as distance matrix/distance"""
"1","
"
"1","[1]"
"1"," ""extracting within-group diversities..."""
"1","
"
"1","[1]"
"1"," ""extracting between-group diversities, one-vs-all"""
"1","
"
"0","plot_age_strat_beta_within_betweenHHID <- lapply(betadivs_separated_age, bind_rows, .id = ""comparison"") %>% bind_rows(.id = ""smoking_exposure_ga"") %>% "
"0","  select(-HHID) %>% "
"0","  merge(., sample_size_map, by = ""smoking_exposure_ga"", sort = FALSE) %>% "
"0","  ggplot(aes(x = full_name, fill = comparison, y = value))+"
"0","  geom_violin(alpha = 0.5)+"
"0","  geom_boxplot(width = 0.4, show.legend = FALSE)+ "
"0","  scale_fill_manual(name = ""Beta Comparison"", labels = c(""Between"", ""Within""), values = ggsci::pal_futurama()(3)[c(1,3)])+"
"0","  xlab(""Age category"")+ "
"0","  ylab(""Bray-Curtis dissimilarity"")+"
"0","  theme_light()+"
"0","  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ "
"0","  labs(title = ""Diversity of people by age"","
"0","       caption = paste0(""only households with "", n_members, "" members""))"
"0",""
"0","plot_age_strat_beta_within_betweenHHID"
"0",""
